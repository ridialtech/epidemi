{% extends 'admin/base.html.twig' %}
{% block title %}Carte du Sénégal{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        #map { height: 500px; }
    </style>

{% endblock %}

{% block content %}
<h1 class="h3 mb-4 text-gray-800">Carte du Sénégal</h1>
<div id="map" style="height: 500px;"></div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ apiKey }}&callback=initMap" async defer></script>
    <script>
        const zoneData = {{ zones|json_encode|raw }};

        const regionPolygons = {
            'dakar': [[
                [14.7, -17.6], [14.7, -17.2], [14.95, -17.2], [14.95, -17.6]
            ]],
            'thies': [[
                [14.8, -17.0], [14.8, -16.0], [15.4, -16.0], [15.4, -17.0]
            ]],
            'diourbel': [[
                [14.6, -16.1], [14.6, -15.4], [15.1, -15.4], [15.1, -16.1]
            ]],
            'fatick': [[
                [14.0, -16.8], [14.0, -15.6], [14.6, -15.6], [14.6, -16.8]
            ]],
            'kaolack': [[
                [13.9, -16.5], [13.9, -15.3], [14.4, -15.3], [14.4, -16.5]
            ]],
            'kaffrine': [[
                [13.7, -15.3], [13.7, -14.0], [14.6, -14.0], [14.6, -15.3]
            ]],
            'louga': [[
                [15.2, -16.7], [15.2, -15.3], [16.0, -15.3], [16.0, -16.7]
            ]],
            'saint-louis': [[
                [15.7, -16.6], [15.7, -15.6], [16.7, -15.6], [16.7, -16.6]
            ]],
            'matam': [[
                [14.8, -14.0], [14.8, -12.7], [16.0, -12.7], [16.0, -14.0]
            ]],
            'tambacounda': [[
                [13.4, -14.3], [13.4, -12.6], [15.0, -12.6], [15.0, -14.3]
            ]],
            'kedougou': [[
                [12.3, -13.2], [12.3, -11.8], [13.2, -11.8], [13.2, -13.2]
            ]],
            'sedhiou': [[
                [12.5, -15.8], [12.5, -14.8], [13.3, -14.8], [13.3, -15.8]
            ]],
            'kolda': [[
                [12.7, -14.8], [12.7, -13.7], [13.5, -13.7], [13.5, -14.8]
            ]],
            'ziguinchor': [[
                [12.3, -16.0], [12.3, -15.2], [13.1, -15.2], [13.1, -16.0]
            ]],
        };

        function normalizeName(name) {
            return name.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
        }

        function statusColor(status) {
            if (status === 'rouge') return '#dc3545';
            if (status === 'orange') return '#ffc107';
            return '#28a745';
        }

        function initMap() {
            const center = {lat: 14.5, lng: -14.5};
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 6,
                center: center
            });

            zoneData.forEach(function(z) {
                const key = normalizeName(z.name);
                const regions = regionPolygons[key];
                if (!regions) return;
                regions.forEach(function(coords) {
                    const path = coords.map(function(c) { return {lat: c[0], lng: c[1]}; });
                    const polygon = new google.maps.Polygon({
                        paths: path,
                        strokeColor: statusColor(z.status),
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: statusColor(z.status),
                        fillOpacity: 0.35
                    });
                    polygon.setMap(map);
                });
            });

        }
    </script>
{% endblock %}
